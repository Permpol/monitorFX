<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EA Trading Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1420;
    --surface2: #111927;
    --border: #1e2d42;
    --accent: #00d4ff;
    --accent2: #0088ff;
    --green: #00ff88;
    --red: #ff3b5c;
    --yellow: #ffcc00;
    --text: #e0eaf8;
    --muted: #4a6080;
    --glow: 0 0 20px rgba(0, 212, 255, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
      radial-gradient(ellipse 60% 40% at 10% 10%, rgba(0,136,255,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 50% 50% at 90% 80%, rgba(0,212,255,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 20px;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 28px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header-left { display: flex; flex-direction: column; gap: 4px; }

  .brand {
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--accent);
    opacity: 0.7;
  }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(22px, 4vw, 34px);
    font-weight: 800;
    color: var(--text);
    line-height: 1;
    letter-spacing: -0.5px;
  }

  h1 span { color: var(--accent); }

  .ea-tag {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2px;
    margin-top: 2px;
  }

  /* STATUS BAR */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 7px;
    background: rgba(0, 255, 136, 0.08);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 11px;
    color: var(--green);
    font-weight: 600;
    letter-spacing: 1.5px;
  }

  .live-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0,255,136,0.4); }
    50% { opacity: 0.6; box-shadow: 0 0 0 4px rgba(0,255,136,0); }
  }

  .refresh-info {
    font-size: 11px;
    color: var(--muted);
  }

  /* REFRESH CONTROLS */
  .controls {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 14px;
  }

  .controls label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .controls select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 4px 8px;
    cursor: pointer;
    outline: none;
  }

  .controls select:focus { border-color: var(--accent); }

  .btn-refresh {
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    border: none;
    border-radius: 6px;
    color: var(--bg);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    padding: 5px 12px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: opacity 0.2s;
  }

  .btn-refresh:hover { opacity: 0.85; }

  /* PROGRESS BAR */
  .progress-wrap {
    width: 100%;
    height: 2px;
    background: var(--border);
    border-radius: 1px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 1px;
    transition: width 1s linear;
    box-shadow: 0 0 8px var(--accent);
  }

  /* SUMMARY CARDS */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px;
    margin-bottom: 28px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, transform 0.2s;
  }

  .card:hover {
    border-color: rgba(0,212,255,0.3);
    transform: translateY(-1px);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.5;
  }

  .card.green::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
  .card.red::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
  .card.yellow::before { background: linear-gradient(90deg, transparent, var(--yellow), transparent); }

  .card-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .card-value {
    font-family: 'Syne', sans-serif;
    font-size: clamp(20px, 3vw, 28px);
    font-weight: 800;
    line-height: 1;
  }

  .card-value.positive { color: var(--green); }
  .card-value.negative { color: var(--red); }
  .card-value.neutral { color: var(--accent); }
  .card-value.yellow { color: var(--yellow); }

  .card-sub {
    font-size: 10px;
    color: var(--muted);
    margin-top: 6px;
  }

  /* TABLE */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }

  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 10px;
  }

  .table-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text);
  }

  .record-count {
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 10px;
  }

  .table-scroll { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
  }

  thead th {
    background: var(--surface2);
    padding: 11px 14px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
  }

  tbody tr {
    border-bottom: 1px solid rgba(30, 45, 66, 0.5);
    transition: background 0.15s;
    animation: rowFadeIn 0.4s ease both;
  }

  @keyframes rowFadeIn {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  tbody tr:hover { background: rgba(0,212,255,0.03); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 12px 14px;
    font-size: 12px;
    white-space: nowrap;
  }

  .ticket-cell {
    font-weight: 700;
    color: var(--accent);
    font-size: 11px;
  }

  .order-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 9px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .order-badge.buy {
    background: rgba(0,255,136,0.1);
    color: var(--green);
    border: 1px solid rgba(0,255,136,0.2);
  }

  .order-badge.sell {
    background: rgba(255,59,92,0.1);
    color: var(--red);
    border: 1px solid rgba(255,59,92,0.2);
  }

  .symbol-cell {
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text);
    text-transform: uppercase;
    font-size: 11px;
  }

  .profit-cell { font-weight: 700; font-size: 13px; }
  .profit-cell.pos { color: var(--green); }
  .profit-cell.neg { color: var(--red); }

  .bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
  }

  .mini-bar-bg {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .mini-bar {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  .mini-bar.green { background: var(--green); box-shadow: 0 0 6px rgba(0,255,136,0.4); }
  .mini-bar.red { background: var(--red); box-shadow: 0 0 6px rgba(255,59,92,0.4); }

  .bar-val {
    font-size: 11px;
    min-width: 55px;
    text-align: right;
  }

  .pct-cell { font-size: 11px; }
  .pct-cell.pos { color: var(--green); }
  .pct-cell.neg { color: var(--red); }

  .recovery-cell {
    font-size: 11px;
    color: var(--yellow);
  }

  /* LOADING / ERROR */
  .state-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    gap: 14px;
  }

  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .state-text { font-size: 13px; color: var(--muted); }

  .error-icon { font-size: 28px; }

  .last-updated {
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    padding: 12px;
    border-top: 1px solid var(--border);
    letter-spacing: 1px;
  }


  /* 24-HOUR PANEL */
  .hour-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 28px;
  }

  .hour-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 10px;
  }

  .hour-section-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .hour-tz-badge {
    font-size: 10px;
    color: var(--accent);
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 20px;
    padding: 3px 10px;
    letter-spacing: 1px;
  }

  .hour-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0;
  }

  @media (max-width: 900px) { .hour-grid { grid-template-columns: repeat(4, 1fr); } }
  @media (max-width: 600px) { .hour-grid { grid-template-columns: repeat(3, 1fr); } }

  .hour-cell {
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    padding: 12px 10px;
    text-align: center;
    position: relative;
    transition: background 0.2s;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .hour-cell:hover { filter: brightness(1.15); }
  .hour-cell:nth-child(6n) { border-right: none; }
  .hour-cell.current-hour {
    box-shadow: inset 0 0 0 2px rgba(0,212,255,0.6);
  }
  .hour-cell.bg-pos {
    background: rgba(0, 255, 136, 0.13);
    border-color: rgba(0, 255, 136, 0.2);
  }
  .hour-cell.bg-neg {
    background: rgba(255, 59, 92, 0.13);
    border-color: rgba(255, 59, 92, 0.2);
  }
  .hour-cell.bg-pos.current-hour {
    background: rgba(0, 255, 136, 0.18);
    box-shadow: inset 0 0 0 2px rgba(0,212,255,0.6);
  }
  .hour-cell.bg-neg.current-hour {
    background: rgba(255, 59, 92, 0.18);
    box-shadow: inset 0 0 0 2px rgba(0,212,255,0.6);
  }

  .hour-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    font-weight: 600;
  }

  .hour-cell.current-hour .hour-label { color: var(--accent); }
  .hour-cell.bg-pos .hour-label { color: rgba(0,255,136,0.7); }
  .hour-cell.bg-neg .hour-label { color: rgba(255,59,92,0.7); }
  .hour-cell.bg-pos .hour-count { color: rgba(0,255,136,0.5); }
  .hour-cell.bg-neg .hour-count { color: rgba(255,59,92,0.5); }
  .hour-cell.bg-pos .hour-profit { color: #fff; text-shadow: 0 0 16px rgba(0,255,136,0.6); }
  .hour-cell.bg-neg .hour-profit { color: #fff; text-shadow: 0 0 16px rgba(255,59,92,0.6); }

  .hour-profit {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 800;
    line-height: 1;
  }

  .hour-profit.pos { color: var(--green); text-shadow: 0 0 12px rgba(0,255,136,0.4); }
  .hour-profit.neg { color: var(--red);   text-shadow: 0 0 12px rgba(255,59,92,0.4); }
  .hour-profit.zero { color: var(--border); }

  .hour-count {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .hour-bar {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    border-radius: 0 0 2px 2px;
    transition: width 0.5s ease;
  }

  .hour-bar.pos { background: linear-gradient(90deg, var(--green), rgba(0,255,136,0.3)); }
  .hour-bar.neg { background: linear-gradient(90deg, var(--red), rgba(255,59,92,0.3)); }

  .hour-summary {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 11px;
    color: var(--muted);
  }

  .hour-summary span { color: var(--text); font-weight: 600; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  @media (max-width: 600px) {
    header { flex-direction: column; }
    .controls { width: 100%; }
  }
</style>
</head>
<body>

  <!-- HOW TO RUN NOTICE -->
  <div id="run-notice" style="display:none;position:fixed;bottom:20px;right:20px;z-index:9999;background:#111927;border:1px solid #ffcc00;border-radius:10px;padding:16px 20px;max-width:360px;font-size:11px;line-height:1.8;font-family:'JetBrains Mono',monospace;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
    <div style="color:#ffcc00;font-weight:700;font-size:12px;margin-bottom:8px">‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Local Server</div>
    <div style="color:#aaa">Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Å fetch ‡∏à‡∏≤‡∏Å <code style="color:#00d4ff">file://</code></div>
    <div style="color:#aaa;margin-top:6px">‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Terminal:</div>
    <div style="background:#080c14;border-radius:6px;padding:8px 10px;margin-top:6px;color:#00ff88;user-select:all">python3 -m http.server 8888</div>
    <div style="color:#aaa;margin-top:6px">‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î: <a href="http://localhost:8888" target="_blank" style="color:#00d4ff">http://localhost:8888</a></div>
    <div style="color:#666;margin-top:8px;font-size:10px">‡∏´‡∏£‡∏∑‡∏≠ VS Code ‚Üí Live Server extension</div>
    <button onclick="document.getElementById('run-notice').style.display='none'" style="margin-top:10px;background:#1e2d42;border:1px solid #1e2d42;border-radius:5px;color:#aaa;padding:4px 10px;cursor:pointer;font-family:inherit;font-size:10px">‡∏õ‡∏¥‡∏î</button>
  </div>

<div class="container">

  <!-- HEADER -->
  <header>
    <div class="header-left">
      <div class="brand">EA Monitor System</div>
      <h1>TRADING <span>DASHBOARD</span></h1>
      <div class="ea-tag" id="ea-name">BTC_2K30C70_REAL ¬∑ BTCUSDM</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
      <div class="status-bar">
        <div class="live-badge"><div class="live-dot"></div>LIVE</div>
        <div class="refresh-info">AUTO REFRESH: <span id="next-refresh">60s</span></div>
      </div>
      <div class="controls">
        <label>INTERVAL</label>
        <select id="interval-select">
          <option value="30">30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="60" selected>1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="120">2 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="300">5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
        </select>
        <button class="btn-refresh" onclick="fetchData()">‚ü≥ REFRESH</button>
      </div>
    </div>
  </header>

  <!-- PROGRESS -->
  <div class="progress-wrap">
    <div class="progress-bar" id="progress-bar" style="width:100%"></div>
  </div>

  <!-- SUMMARY -->
  <div class="summary-grid" id="summary-grid">
    <div class="card"><div class="card-label">Total Records</div><div class="card-value neutral" id="s-total">‚Äî</div><div class="card-sub">Unique tickets</div></div>
    <div class="card green"><div class="card-label">Sum Max Profit</div><div class="card-value positive" id="s-max-sum">‚Äî</div><div class="card-sub">max_current_profit ‡∏£‡∏ß‡∏°</div></div>
    <div class="card red"><div class="card-label">Sum Min Profit</div><div class="card-value negative" id="s-min-sum">‚Äî</div><div class="card-sub">min_current_profit ‡∏£‡∏ß‡∏°</div></div>
    <div class="card yellow"><div class="card-label">Net Profit</div><div class="card-value" id="s-net" style="color:var(--yellow)">‚Äî</div><div class="card-sub">current_profit ‡∏£‡∏ß‡∏°</div></div>
    <div class="card"><div class="card-label">Win Rate</div><div class="card-value neutral" id="s-winrate">‚Äî</div><div class="card-sub">Positive trades</div></div>
  </div>


  <!-- 24-HOUR PANEL -->
  <div class="hour-section">
    <div class="hour-section-header">
      <div class="hour-section-title">24H PROFIT HEATMAP</div>
      <div class="hour-tz-badge">üáπüá≠ THAILAND TIME (UTC+7)</div>
    </div>
    <div class="hour-grid" id="hour-grid">
      <!-- filled by JS -->
    </div>
    <div class="hour-summary" id="hour-summary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <div class="table-header">
      <div class="table-title">CLOSED POSITIONS</div>
      <div class="record-count" id="record-count">0 records</div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>TICKET</th>
            <th>TYPE</th>
            <th>SYMBOL</th>
            <th>CURRENT PROFIT</th>
            <th>MAX PROFIT</th>
            <th>MIN PROFIT</th>
            <th>MAX % OF TP</th>
            <th>MIN % OF SL</th>
            <th>MAX RECOVERY (s)</th>
            <th>CLOSE REASON</th>
            <th>CLOSED AT</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="12"><div class="state-box"><div class="spinner"></div><div class="state-text">Loading data...</div></div></td></tr>
        </tbody>
      </table>
    </div>
    <div class="last-updated" id="last-updated">‚Äî</div>
  </div>

</div>

<script>
const API_DIRECT = "https://allie-capacitive-kaiden.ngrok-free.app/ea/status/pairs/M_6_INVERT3_Enhanced_Real1?symbol=xauusdm&limit=100";
const isLocalProxy = ['localhost','127.0.0.1'].includes(window.location.hostname);
// When on localhost ‚Üí use python proxy (/api/ route) which fetches server-side (no CORS)
// When not on localhost ‚Üí try direct + public proxies
const API_LOCAL  = window.location.origin + "/api/ea/status/pairs/M_6_INVERT3_Enhanced_Real1?symbol=xauusdm&limit=100";
let intervalId = null;
let countdownId = null;
let secondsLeft = 60;
let totalSeconds = 60;

// ‚îÄ‚îÄ Thai Time Helpers (UTC+7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toThaiTime(ts) {
  if (!ts) return new Date();
  // API returns timestamps WITHOUT 'Z' suffix (e.g. "2026-02-23T03:09:45.764000")
  // Force treat as UTC by appending 'Z' if not present
  const utcStr = ts.endsWith('Z') ? ts : ts.replace(' ', 'T') + 'Z';
  const d = new Date(utcStr);
  return new Date(d.getTime() + 7 * 60 * 60 * 1000);
}

function fmtTimeTH(ts) {
  if (!ts) return '‚Äî';
  const d = toThaiTime(ts);
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getUTCDate())}/${pad(d.getUTCMonth()+1)}/${String(d.getUTCFullYear()).slice(-2)} `
       + `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
}

function fmtTime(ts) {
  return fmtTimeTH(ts);
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


function fmt(v, digits=2) {
  if (v === null || v === undefined) return '<span style="color:var(--muted)">‚Äî</span>';
  const n = parseFloat(v);
  const cls = n >= 0 ? 'pos' : 'neg';
  const sign = n >= 0 ? '+' : '';
  return `<span class="${cls}">${sign}${n.toFixed(digits)}</span>`;
}

function fmtPct(v) {
  if (v === null || v === undefined) return '<span style="color:var(--muted)">‚Äî</span>';
  const n = parseFloat(v);
  const cls = n >= 0 ? 'pos' : 'neg';
  return `<span class="pct-cell ${cls}">${n.toFixed(2)}%</span>`;
}

function miniBar(val, maxAbs, isMin) {
  if (val === null || val === undefined) return '<span style="color:var(--muted)">‚Äî</span>';
  const n = parseFloat(val);
  const pct = maxAbs > 0 ? Math.min(Math.abs(n) / maxAbs * 100, 100) : 0;
  const color = isMin ? 'red' : 'green';
  const sign = n >= 0 ? '+' : '';
  return `<div class="bar-wrap">
    <div class="mini-bar-bg"><div class="mini-bar ${color}" style="width:${pct}%"></div></div>
    <span class="bar-val ${n>=0?'pos':'neg'}">${sign}${n.toFixed(2)}</span>
  </div>`;
}

function closeReasonBadge(r) {
  const colors = { TP:'var(--green)', SL:'var(--red)', Manual:'var(--yellow)' };
  const c = colors[r] || 'var(--muted)';
  return `<span style="color:${c};font-size:10px;font-weight:700;letter-spacing:1px">${r||'‚Äî'}</span>`;
}



async function fetchData() {
  setLoadingState();
  // Build strategies based on environment
  const encoded = encodeURIComponent(API_DIRECT);
  const strategies = isLocalProxy ? [
    // ‚òÖ On localhost: use Python proxy (server-side, no CORS issue at all)
    () => fetch(API_LOCAL, { headers: { 'accept': 'application/json' } }),
  ] : [
    // Direct with ngrok bypass header
    () => fetch(API_DIRECT, {
      headers: { 'ngrok-skip-browser-warning': '69420', 'accept': 'application/json' },
    }),
    // allorigins proxy
    async () => {
      const r = await fetch(`https://api.allorigins.win/get?url=${encoded}&timestamp=${Date.now()}`);
      if (!r.ok) throw new Error('allorigins failed');
      const j = await r.json();
      return { ok: true, json: () => JSON.parse(j.contents), _proxy: 'allorigins' };
    },
  ];

  for (let i = 0; i < strategies.length; i++) {
    try {
      const res = await strategies[i]();
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      renderData(json);
      const proxyLabel = res._proxy ? ` (${res._proxy})` : (i > 0 ? ` (proxy ${i})` : '');
      document.getElementById('last-updated').textContent =
        '‚úì Last updated: ' + new Date().toLocaleString('th-TH', { hour12: false }) + proxyLabel;
      return;
    } catch (e) {
      if (i < strategies.length - 1) continue;
      showError(e.message);
    }
  }
}

function setLoadingState() {
  // Only show spinner if table is empty
  const tbody = document.getElementById('table-body');
  if (tbody.querySelector('.state-box')) {
    tbody.innerHTML = `<tr><td colspan="12"><div class="state-box"><div class="spinner"></div><div class="state-text">Fetching data...</div></div></td></tr>`;
  }
}

function showError(msg) {
  document.getElementById('table-body').innerHTML = `<tr><td colspan="12">
    <div class="state-box">
      <div class="error-icon">‚ö†</div>
      <div class="state-text" style="color:var(--red);font-size:13px">Connection Failed</div>
      <div class="state-text">${msg}</div>
      <div style="margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px 18px;max-width:480px;font-size:11px;line-height:1.8;color:var(--muted)">
        <div style="color:var(--yellow);font-weight:700;margin-bottom:6px;letter-spacing:1px">‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CORS:</div>
        <div>1. ‡πÄ‡∏õ‡∏¥‡∏î ngrok URL ‡πÉ‡∏ô browser ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "Visit Site"</div>
        <div>2. ‡πÉ‡∏ä‡πâ ngrok config ‡πÄ‡∏û‡∏¥‡πà‡∏° <code style="color:var(--accent)">--request-header-add "Access-Control-Allow-Origin: *"</code></div>
        <div>3. ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° middleware CORS ‡πÉ‡∏ô API server</div>
        <div style="margin-top:8px">
          <a href="${API_URL}" target="_blank" style="color:var(--accent);text-decoration:none">‚Üí ‡πÄ‡∏õ‡∏¥‡∏î API URL ‡πÉ‡∏ô tab ‡πÉ‡∏´‡∏°‡πà</a>
        </div>
      </div>
    </div>
  </td></tr>`;
  document.getElementById('last-updated').textContent = '‚úó Failed at: ' + new Date().toLocaleString('th-TH', { hour12: false });
}



function renderHourPanel(rows) {
  // Build 24 buckets by Thai hour (0-23)
  const buckets = Array.from({length: 24}, () => ({ profit: 0, count: 0 }));

  for (const item of rows) {
    const ts = item.close.timestamp;
    if (!ts) continue;
    const thaiDate = toThaiTime(ts);
    const hr = thaiDate.getUTCHours(); // Thai hour
    const cp = parseFloat(item.close.current_profit ?? 0);
    buckets[hr].profit += cp;
    buckets[hr].count++;
  }

  // Current Thai hour
  const nowThai = toThaiTime(new Date().toISOString());
  const currentHour = nowThai.getUTCHours();

  // Find max abs for bar scaling
  const maxAbs = Math.max(...buckets.map(b => Math.abs(b.profit)), 1);

  let html = '';
  for (let h = 0; h < 24; h++) {
    const b = buckets[h];
    const isCurrent = h === currentHour;
    const pct = (Math.abs(b.profit) / maxAbs * 100).toFixed(1);
    const cls = b.profit > 0 ? 'pos' : b.profit < 0 ? 'neg' : 'zero';
    const sign = b.profit > 0 ? '+' : '';
    const profitStr = b.count > 0
      ? `<div class="hour-profit ${cls}">${sign}${b.profit.toFixed(2)}</div>`
      : `<div class="hour-profit zero">¬∑</div>`;
    const countStr = b.count > 0
      ? `<div class="hour-count">${b.count} trade${b.count>1?'s':''}</div>`
      : `<div class="hour-count">‚Äî</div>`;
    const barHtml = b.count > 0
      ? `<div class="hour-bar ${cls}" style="width:${pct}%"></div>`
      : '';

    const bgCls = b.count > 0 ? (b.profit > 0 ? ' bg-pos' : ' bg-neg') : '';
    html += `<div class="hour-cell${isCurrent?' current-hour':''}${bgCls}">
      <div class="hour-label">${String(h).padStart(2,'0')}:00${isCurrent?' ‚óÄ':''}</div>
      ${profitStr}
      ${countStr}
      ${barHtml}
    </div>`;
  }

  document.getElementById('hour-grid').innerHTML = html;

  // Summary
  const totalTrades = buckets.reduce((s,b) => s + b.count, 0);
  const profitHours = buckets.filter(b => b.profit > 0).length;
  const lossHours   = buckets.filter(b => b.profit < 0).length;
  const best  = buckets.reduce((a,b,i) => b.profit > a.val ? {val:b.profit, hr:i} : a, {val:-Infinity, hr:-1});
  const worst = buckets.reduce((a,b,i) => b.profit < a.val ? {val:b.profit, hr:i} : a, {val:Infinity,  hr:-1});

  const bestStr  = best.hr  >= 0 && buckets[best.hr].count  > 0 ? `<span style="color:var(--green)">${String(best.hr).padStart(2,'0')}:00 (+${best.val.toFixed(2)})</span>` : '<span>‚Äî</span>';
  const worstStr = worst.hr >= 0 && buckets[worst.hr].count > 0 ? `<span style="color:var(--red)">${String(worst.hr).padStart(2,'0')}:00 (${worst.val.toFixed(2)})</span>` : '<span>‚Äî</span>';

  document.getElementById('hour-summary').innerHTML =
    `Total trades: <span>${totalTrades}</span> &nbsp;|&nbsp; ` +
    `Profit hours: <span style="color:var(--green)">${profitHours}</span> &nbsp;|&nbsp; ` +
    `Loss hours: <span style="color:var(--red)">${lossHours}</span> &nbsp;|&nbsp; ` +
    `Best hour: ${bestStr} &nbsp;|&nbsp; ` +
    `Worst hour: ${worstStr}`;
}

function getTodayThai() {
  const now = new Date(Date.now() + 7 * 60 * 60 * 1000);
  return { y: now.getUTCFullYear(), m: now.getUTCMonth(), d: now.getUTCDate() };
}

function isTodayThai(ts) {
  if (!ts) return false;
  const utcStr = ts.endsWith('Z') ? ts : ts.replace(' ', 'T') + 'Z';
  const thai = new Date(new Date(utcStr).getTime() + 7 * 60 * 60 * 1000);
  const today = getTodayThai();
  return thai.getUTCFullYear() === today.y &&
         thai.getUTCMonth()    === today.m &&
         thai.getUTCDate()     === today.d;
}

function renderData(json) {
  const data = json.data || [];

  // Filter: close status + TODAY (Thai time UTC+7) + unique tickets
  const ticketMap = new Map();
  for (const item of data) {
    if (item.close && item.close.status === 'close' && isTodayThai(item.close.timestamp)) {
      const tk = item.ticket;
      const existing = ticketMap.get(tk);
      if (!existing || new Date(item.close.timestamp) >= new Date(existing.close.timestamp)) {
        ticketMap.set(tk, item);
      }
    }
  }

  // Sort by close timestamp descending
  const rows = [...ticketMap.values()].sort((a, b) =>
    new Date(b.close.timestamp) - new Date(a.close.timestamp)
  );

  // Summary
  let maxSum = 0, minSum = 0, netSum = 0, wins = 0;
  const allMaxAbs = Math.max(...rows.map(r => Math.abs(r.close.max_current_profit ?? 0)), 1);
  const allMinAbs = Math.max(...rows.map(r => Math.abs(r.close.min_current_profit ?? 0)), 1);

  for (const r of rows) {
    const cp = parseFloat(r.close.current_profit ?? 0);
    const mx = parseFloat(r.close.max_current_profit ?? 0);
    const mn = parseFloat(r.close.min_current_profit ?? 0);
    maxSum += mx;
    minSum += mn;
    netSum += cp;
    if (cp > 0) wins++;
  }

  renderHourPanel(rows);
  document.getElementById('s-total').textContent = rows.length;
  const mxEl = document.getElementById('s-max-sum');
  mxEl.textContent = (maxSum >= 0 ? '+' : '') + maxSum.toFixed(2);
  mxEl.className = 'card-value ' + (maxSum >= 0 ? 'positive' : 'negative');

  const mnEl = document.getElementById('s-min-sum');
  mnEl.textContent = (minSum >= 0 ? '+' : '') + minSum.toFixed(2);
  mnEl.className = 'card-value ' + (minSum >= 0 ? 'positive' : 'negative');

  const netEl = document.getElementById('s-net');
  netEl.textContent = (netSum >= 0 ? '+' : '') + netSum.toFixed(2);
  netEl.className = 'card-value ' + (netSum >= 0 ? 'positive' : 'negative');

  const wr = rows.length > 0 ? ((wins / rows.length) * 100).toFixed(1) : 0;
  document.getElementById('s-winrate').textContent = wr + '%';
  const td = getTodayThai();
  const pad2 = n => String(n).padStart(2,'0');
  document.getElementById('record-count').textContent = rows.length + ' records ¬∑ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ' + pad2(td.d) + '/' + pad2(td.m+1) + '/' + td.y;

  if (json.ea_name) document.getElementById('ea-name').textContent = json.ea_name + ' ¬∑ ' + (json.symbol_filter || '').toUpperCase();

  // Table
  if (rows.length === 0) {
    const todayLabel = (() => {
      const t = getTodayThai();
      const pad = n => String(n).padStart(2,'0');
      return `${pad(t.d)}/${pad(t.m+1)}/${t.y}`;
    })();
    document.getElementById('table-body').innerHTML = `<tr><td colspan="12"><div class="state-box"><div class="state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${todayLabel} ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)</div></div></td></tr>`;
    return;
  }

  let html = '';
  rows.forEach((item, i) => {
    const c = item.close;
    const delay = i * 40;
    html += `<tr style="animation-delay:${delay}ms">
      <td style="color:var(--muted);font-size:11px">${i + 1}</td>
      <td class="ticket-cell">${item.ticket}</td>
      <td><span class="order-badge ${item.order_type}">${item.order_type.toUpperCase()}</span></td>
      <td class="symbol-cell">${item.symbol}</td>
      <td class="profit-cell ${(c.current_profit??0)>=0?'pos':'neg'}">${fmt(c.current_profit)}</td>
      <td>${miniBar(c.max_current_profit, allMaxAbs, false)}</td>
      <td>${miniBar(c.min_current_profit, allMinAbs, true)}</td>
      <td>${fmtPct(c.max_profit_percent_of_tp)}</td>
      <td>${fmtPct(c.min_profit_percent_of_sp)}</td>
      <td class="recovery-cell">${c.max_recovery_seconds !== null && c.max_recovery_seconds !== undefined ? c.max_recovery_seconds + 's' : '‚Äî'}</td>
      <td>${closeReasonBadge(c.close_reason)}</td>
      <td style="color:var(--muted);font-size:11px">${fmtTime(c.timestamp)}</td>
    </tr>`;
  });

  document.getElementById('table-body').innerHTML = html;
}

// Countdown & auto refresh
function startCountdown() {
  const select = document.getElementById('interval-select');
  totalSeconds = parseInt(select.value);
  secondsLeft = totalSeconds;
  updateProgress();

  clearInterval(countdownId);
  countdownId = setInterval(() => {
    secondsLeft--;
    updateProgress();
    if (secondsLeft <= 0) {
      secondsLeft = totalSeconds;
      fetchData();
    }
  }, 1000);
}

function updateProgress() {
  const pct = (secondsLeft / totalSeconds) * 100;
  document.getElementById('progress-bar').style.width = pct + '%';
  const s = secondsLeft;
  document.getElementById('next-refresh').textContent = s >= 60 ? Math.floor(s/60)+'m '+( s%60 ? (s%60)+'s' : '') : s+'s';
}

document.getElementById('interval-select').addEventListener('change', () => {
  clearInterval(intervalId);
  startCountdown();
});


// Detect file:// protocol
if (window.location.protocol === 'file:') {
  document.getElementById('run-notice').style.display = 'block';
}

// Init
fetchData();
startCountdown();
</script>
</body>
</html>
